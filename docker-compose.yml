services:
  server:
    build:
      context: .
    ports:
      - 3000:3000
    volumes:
    restart: unless_stopped
    depends_on:
      - socket-proxy
    environment:
      - NODE_ENV: production
      - DOCKER_HOST: tcp://socket-proxy:2375
    healthcheck:
      - test: [ "CMD", "container_healthcheck" ]
      - interval: 10s
      - timeout: 5s
      - retries: 5

  socket-proxy:
    container_name: socket-proxy
    image: tecnativa/docker-socket-proxy
    restart: unless_stopped
    networks:
      socket_proxy:
        ipv4_address: 192.168.91.254
    privileged: false
    ports:
      - "127.0.0.1:2375:2375"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    environment:
      - LOG_LEVEL=info
      - EVENTS=1
      - PING=1
      - VERSION=1
      - AUTH=0
      - SECRETS=0
      - POST=1
      - BUILD=0
      - COMMIT=0
      - CONFIGS=0
      - CONTAINERS=1
      - DISTRIBUTION=0
      - EXEC=0
      - IMAGES=1
      - INFO=1
      - NETWORKS=1
      - NODES=0
      - PLUGINS=0
      - SERVICES=1
      - SESSION=0
      - SWARM=0
      - SYSTEM=0
      - TASKS=1
      - VOLUMES=1

networks:
  socket_proxy:
    name: socket_proxy
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.91.0/24
